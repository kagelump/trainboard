# Trainboard

A compact static departure board for ODPT train lines. This repo contains a small TypeScript-powered static app that queries ODPT endpoints and shows upcoming departures for any train line supported by the ODPT API.

Highlights of changes in this repo

- Rewrote app in TypeScript with modules: `src/api.ts`, `src/utils.ts`, `src/ui.ts`, `src/cache.ts`, `src/trainboard.ts`.
- **Generalized to support any ODPT train line** with a railway line selector.
- Vite is used for development and fast HMR.
- Support for a user-supplied API key via the settings modal (persisted to localStorage).
- Destination station name caching (SimpleCache) and batch station metadata lookup.
- Unit tests (Vitest) for parsing utilities are included.
- GitHub Pages deploy support and an Actions workflow that builds and publishes `dist/` on push to `main`.

Files

- `trainboard.html` ‚Äî main HTML page (loads built bundle from `dist/`)
- `src/` ‚Äî TypeScript sources
- `dist/` ‚Äî production build output (generated by `npm run build`)

## Local development

1. Install dependencies:

```bash
npm install
```

2. Start the Vite dev server (recommended for editing TypeScript):

```bash
npm run dev
```

Open the URL printed by Vite (usually http://localhost:5173). The dev server serves `index.html` and handles TS HMR.

## Production build

To build a production-ready static site (assets go to `dist/`):

```bash
npm run build
```

`dist/` contains `index.html` and assets. The project is configured so built assets use relative paths (Vite `base: './'`) which makes the site suitable for GitHub Pages or serving from a subpath.

## Publish to GitHub Pages

There are two supported ways to publish:

- Local publish (manual):

  ```bash
  npm run deploy
  # uses the `gh-pages` npm package to push `dist/` to the gh-pages branch
  ```

- CI publish (recommended):

  The repo includes a GitHub Actions workflow at `.github/workflows/deploy.yml` which builds and deploys `dist/` to GitHub Pages when you push to `main`. The workflow uses the repository's `GITHUB_TOKEN` to push the built site ‚Äî no additional secrets are required for basic publish.

Requirements and branch expectations

- The Actions workflow triggers on pushes to `main`. If your default branch is named differently, update `.github/workflows/deploy.yml`.
- The workflow uses the built-in `GITHUB_TOKEN` so it can push to `gh-pages`. If you require a different deployment strategy (deploy to a different branch or use a personal token), update the workflow accordingly.

## API key and configuration

You need to sign up for a developer account at [ODPT](https://developer.odpt.org/) to get API keys.
In particular, the Tokyu system is only available using the
[challenge 2025](https://developer.odpt.org/challengeinfo) API endpoint and token.

The app reads a `config.json` at runtime if present (useful for local testing or static hosting). Example `config.example.json` is provided. Additionally, the settings modal (‚öôÔ∏è button) lets you paste a custom ODPT API key which will be persisted to `localStorage` and used in preference to `config.json`.

How to supply an API key:

1. Copy `config.example.json` to `config.json` and set `ODPT_API_KEY` for a static, server-side config.

```json
{
  "ODPT_API_KEY": "YOUR_KEY_HERE",
  "DEFAULT_RAILWAY": "odpt.Railway:Tokyu.Toyoko",
  "DEFAULT_STATION_NAME": "Ê≠¶ËîµÂ∞èÊùâ (TY11)",
  "API_BASE_URL": "https://api-challenge.odpt.org/api/v4/"
}
```

2. Or: open the settings modal in the UI and paste a custom API key ‚Äî this is persisted to `localStorage` under `t2board_api_key` and takes precedence over `config.json`.

If the app encounters an API error (for example an authentication error), it will display a banner and automatically open the settings modal so you can paste a new API key immediately.

## Selecting Railway Lines and Stations

The app supports any train line available in the ODPT API:

- Click the üöÉ button to select a railway line (persisted to localStorage)
- Click the ‚öôÔ∏è button to select a station on the current line (persisted to localStorage)
- The app will automatically load direction names, train types, and station lists for the selected railway

## Scripts

- `npm run dev` ‚Äî start Vite dev server
- `npm run build` ‚Äî build for production (`dist/`)
- `npm run deploy` ‚Äî build and publish `dist/` to `gh-pages` using `gh-pages` (local push)
- `npm run typecheck` ‚Äî run `tsc --noEmit`
- `npm test` ‚Äî run Vitest tests

## Formatting

This project uses Prettier. To format source files:

```bash
npm run format
```

## CI

The included Actions workflow runs on push to `main`, builds the site, and publishes the `dist/` directory to GitHub Pages using `peaceiris/actions-gh-pages`.

## Raspberry Pi E-Ink Display

You can run this trainboard on a Raspberry Pi with an e-ink display for a physical departure board! See [RASPBERRY_PI_SETUP.md](RASPBERRY_PI_SETUP.md) for detailed instructions on:

- Setting up a Raspberry Pi Zero 2 W with Waveshare e-ink display
- Installing and configuring the software environment
- Automatic display refresh and power management
- Troubleshooting and maintenance

Quick start:
```bash
# On your Raspberry Pi
cd ~/trainboard/scripts/rpi-eink
chmod +x install.sh
./install.sh
```

Notes & next steps

- Consider moving more settings (like API base URL) to `config.json` and adding validation.
- Add more unit tests for UI and caching behavior.
- Add ESLint and a GitHub Actions linting step if desired.
