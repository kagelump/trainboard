# Trainboard

A compact static departure board for ODPT train lines. This repo contains a small TypeScript-powered static app that queries ODPT endpoints and shows upcoming departures for any train line supported by the ODPT API.

Highlights of changes in this repo

- Rewrote app in TypeScript with modules: `src/api.ts`, `src/utils.ts`, `src/ui.ts`, `src/cache.ts`, `src/trainboard.ts`.
- **Generalized to support any ODPT train line** with a railway line selector.
- **URL-based routing** for sharing specific railway/station views with flexible name matching.
- **Geolocation support** for finding nearby stations using the browser's location API.
- Vite is used for development and fast HMR.
- Support for a user-supplied API key via the settings modal (persisted to localStorage).
- Destination station name caching (SimpleCache) and batch station metadata lookup.
- Unit tests (Vitest) for parsing utilities, routing, and geolocation are included.
- GitHub Pages deploy support and an Actions workflow that builds and publishes `dist/` on push to `main`.

Files

- `trainboard.html` ‚Äî main HTML page (loads built bundle from `dist/`)
- `src/` ‚Äî TypeScript sources
- `dist/` ‚Äî production build output (generated by `npm run build`)

## Local development

1. Install dependencies:

```bash
npm install
```

2. Start the Vite dev server (recommended for editing TypeScript):

```bash
npm run dev
```

Open the URL printed by Vite (usually http://localhost:5173). The dev server serves `index.html` and handles TS HMR.

## Production build

To build a production-ready static site (assets go to `dist/`):

```bash
npm run build
```

`dist/` contains `index.html` and assets. The project is configured so built assets use relative paths (Vite `base: './'`) which makes the site suitable for GitHub Pages or serving from a subpath.

### URL Routing for GitHub Pages

The app supports client-side URL routing with paths like `/railway/{name}/station/{name}`. When deployed to GitHub Pages at a repository path (e.g., `https://username.github.io/trainboard/`), the routing automatically detects the base path and handles URLs correctly.

**How it works:**

- The app auto-detects the base path from the URL structure
- When on GitHub Pages at `/trainboard/`, URLs will be `/trainboard/railway/.../station/...`
- When running locally or at the domain root, URLs will be `/railway/.../station/...`
- The 404.html file enables SPA routing on GitHub Pages

**Custom base path (optional):**
If you need to override the auto-detection, set the `VITE_BASE_PATH` environment variable during build:

```bash
VITE_BASE_PATH=/my-custom-path npm run build
```

## Publish to GitHub Pages

There are two supported ways to publish:

- Local publish (manual):

  ```bash
  npm run deploy
  # uses the `gh-pages` npm package to push `dist/` to the gh-pages branch
  ```

- CI publish (recommended):

  The repo includes a GitHub Actions workflow at `.github/workflows/deploy.yml` which builds and deploys `dist/` to GitHub Pages when you push to `main`. The workflow uses the repository's `GITHUB_TOKEN` to push the built site ‚Äî no additional secrets are required for basic publish.

Requirements and branch expectations

- The Actions workflow triggers on pushes to `main`. If your default branch is named differently, update `.github/workflows/deploy.yml`.
- The workflow uses the built-in `GITHUB_TOKEN` so it can push to `gh-pages`. If you require a different deployment strategy (deploy to a different branch or use a personal token), update the workflow accordingly.

## API key and configuration

You need to sign up for a developer account at [ODPT](https://developer.odpt.org/) to get API keys.
In particular, the Tokyu system is only available using the
[challenge 2025](https://developer.odpt.org/challengeinfo) API endpoint and token.

### Option 1: Cloudflare API Proxy (Recommended for Production)

For production deployments, use a Cloudflare Worker to proxy API requests and keep your API key secure. This approach:

- Keeps your API key secret (never exposed to browsers)
- Improves performance with edge caching
- Runs on Cloudflare's free tier

See [scripts/cloudflare/README.md](scripts/cloudflare/README.md) for detailed setup instructions.

Quick start:

```bash
cd scripts/cloudflare
./setup.sh    # Interactive setup
./deploy.sh   # Deploy to Cloudflare
```

Then edit `defaults.json` (compile-time defaults) to use the proxy:

```json
{
  "API_BASE_URL": "https://odpt-api-proxy.YOUR-SUBDOMAIN.workers.dev/",
  "DEFAULT_RAILWAY": "odpt.Railway:Tokyu.Toyoko",
  "DEFAULT_STATION_NAME": "Ê≠¶ËîµÂ∞èÊùâ (TY11)"
}
```

## Note about proxy mode

When `API_BASE_URL` contains the word `proxy` the application treats this as a proxy deployment and allows the ODPT API key to be omitted in the browser. In this mode the app will pass a null API key to the client and the client will omit the `acl:consumerKey` query parameter; the proxy is expected to handle authentication and/or to inject the necessary credentials on the server side. This keeps keys out of the browser and is the recommended production setup.

### Option 2: Direct API Access (For Development)

The app loads compile-time defaults from `defaults.json` (committed). This replaces the previous runtime `config.json` behavior ‚Äî defaults are now embedded at build time. Additionally, the settings modal (‚öôÔ∏è button) lets you paste a custom ODPT API key which will be persisted to `localStorage` and used in preference to any compiled defaults.

How to supply an API key:

Recommended: use the Cloudflare API proxy in production so you never expose an API key to the browser (see the Cloudflare section above).

For development or one-off testing you can supply an API key in the browser using the settings modal (‚öôÔ∏è) ‚Äî paste your ODPT API key there and it will be persisted to `localStorage` under `t2board_api_key`.

Notes:

- Do NOT store secret API keys in `defaults.json` in your public repository if you want them to remain secret ‚Äî defaults are compiled into the app. For runtime overrides, use the settings modal which stores keys in `localStorage` instead.
- If the app encounters an API error (for example an authentication error), it will display a banner and automatically open the settings modal so you can paste a new API key immediately.

## Selecting Railway Lines and Stations

The app supports any train line available in the ODPT API:

- Click the üöÉ button to select a railway line (persisted to localStorage)
- Click the ‚öôÔ∏è button to select a station on the current line (persisted to localStorage)
- The app will automatically load direction names, train types, and station lists for the selected railway

### URL-Based Selection

You can share specific railway/station views using URLs:

```
https://kagelump.github.io/trainboard/railway/Tokyu.Toyoko/station/Ê≠¶ËîµÂ∞èÊùâ
```

The URL routing supports flexible matching:

- Full Japanese names: `Ê≠¶ËîµÂ∞èÊùâ` or `Ê≠¶ËîµÂ∞èÊùâ (TY11)`
- Latin ODPT names: `Tokyu.Toyoko` or `JR-East.Yamanote.Tokyo`
- Partial names: `Toyoko` (matches `Tokyu.Toyoko`) or `MusashiKosugi` (matches station name)

### Geolocation Support

The app includes geolocation support to help users find nearby stations:

- Uses browser's Geolocation API to detect current position
- Finds and displays nearby stations sorted by distance
- Calculates distances using Haversine formula for accuracy
- Displays distances in meters or kilometers for easy reading

## Scripts

### Development Scripts

- `npm run dev` ‚Äî start Vite dev server
- `npm run build` ‚Äî build for production (`dist/`)
- `npm run deploy` ‚Äî build and publish `dist/` to `gh-pages` using `gh-pages` (local push)
- `npm run typecheck` ‚Äî run `tsc --noEmit`
- `npm test` ‚Äî run Vitest tests

### Utility Scripts

- **Cloudflare API Proxy** (`scripts/cloudflare/`) ‚Äî Deploy a secure API proxy on Cloudflare Workers
  - See [scripts/cloudflare/README.md](scripts/cloudflare/README.md) for details
- **Python Data Fetching** (`scripts/python/`) ‚Äî Fetch ODPT station data
  - See [scripts/python/README.md](scripts/python/README.md) for details
- **Raspberry Pi E-Ink** (`scripts/rpi-eink/`) ‚Äî Run trainboard on a Raspberry Pi with e-ink display
  - See [scripts/rpi-eink/README.md](scripts/rpi-eink/README.md) and [RASPBERRY_PI_SETUP.md](RASPBERRY_PI_SETUP.md) for details

## Formatting

This project uses Prettier. To format source files:

```bash
npm run format
```

## CI

The included Actions workflow runs on push to `main`, builds the site, and publishes the `dist/` directory to GitHub Pages using `peaceiris/actions-gh-pages`.

## Raspberry Pi E-Ink Display

You can run this trainboard on a Raspberry Pi with an e-ink display for a physical departure board! See [RASPBERRY_PI_SETUP.md](RASPBERRY_PI_SETUP.md) for detailed instructions on:

- Setting up a Raspberry Pi Zero 2 W with Waveshare e-ink display
- Installing and configuring the software environment
- Automatic display refresh and power management
- Troubleshooting and maintenance

Quick start:

```bash
# On your Raspberry Pi
cd ~/trainboard/scripts/rpi-eink
chmod +x install.sh
./install.sh
```

Notes & next steps

- Consider moving more settings (like API base URL) to `defaults.json` and adding validation.
- Add more unit tests for UI and caching behavior.
- Add ESLint and a GitHub Actions linting step if desired.
