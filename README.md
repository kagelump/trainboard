# Trainboard

A compact static departure board for the Tokyu Toyoko Line.

Files

- `trainboard.html` — main HTML page
- `trainboard.js` — extracted JavaScript logic (fetches ODPT data)
- `trainboard.css` — extracted styles

Quick run (two options)

1. Python built-in HTTP server (no install required):

```bash
cd /workspaces/trainboard
python3 -m http.server 8000
# open http://localhost:8000/trainboard.html
```

2. Using `http-server` (npm)

```bash
cd /workspaces/trainboard
# if you haven't installed http-server locally
npm install
npm start
# open http://localhost:8080/trainboard.html (see package.json)
```

Notes

- The ODPT API key is in `trainboard.js` as `ODPT_API_KEY`. Replace it with your own key or change the code to load from an external config.
- The page uses `defer` to load `trainboard.js` and expects the files to be served over HTTP (some browsers block fetch from file://).

Config

- Copy `config.example.json` to `config.json` and replace `YOUR_KEY_HERE` with your actual ODPT API key.
- `config.json` is included in `.gitignore` to avoid committing secrets. Example contents:

```json
{
  "ODPT_API_KEY": "YOUR_KEY_HERE"
}
```

## TypeScript build

This repo includes a TypeScript source at `src/trainboard.ts`. To build it:

```bash
npm install
npm run build
```

The compiled JavaScript will be emitted to `dist/` and `trainboard.html` is already set to load the built file. During development you can run the static server (after building):

```bash
npm start
# open http://localhost:8080/trainboard.html
```

## Vite development (recommended)

I added a Vite workflow for fast TypeScript edit/refresh cycles.

1. Install dev dependencies:

```bash
npm install
```

2. Start the Vite dev server:

```bash
npm run dev
```

3. Open the URL printed by Vite (usually http://localhost:5173). Edit `src/trainboard.ts` and Vite will HMR/refresh the page instantly.

Notes:

- During dev the entry page is `index.html` which imports `/src/trainboard.ts` as an ES module (Vite handles TS).
- `config.json` is served as a static asset at `http://localhost:5173/config.json` so the runtime fetch in the app will work without changes.

## Formatting / editor setup

This project uses Prettier with a 100-character line width. Files added:

- `.prettierrc` — Prettier config (printWidth: 100)
- `.editorconfig` — editor defaults (max_line_length = 100)
- `.vscode/settings.json` — optional VS Code recommended settings (formatOnSave, ruler at 100)

# Trainboard

A compact static departure board for the Tokyu Toyoko Line. This repo contains a small TypeScript-powered static app that queries ODPT endpoints and shows upcoming departures.

Highlights of changes in this repo

- Rewrote app in TypeScript with modules: `src/api.ts`, `src/utils.ts`, `src/ui.ts`, `src/cache.ts`, `src/trainboard.ts`.
- Vite is used for development and fast HMR.
- Support for a user-supplied API key via the settings modal (persisted to localStorage).
- Destination station name caching (SimpleCache) and batch station metadata lookup.
- Unit tests (Vitest) for parsing utilities are included.
- GitHub Pages deploy support and an Actions workflow that builds and publishes `dist/` on push to `main`.

Files

- `trainboard.html` — main HTML page (loads built bundle from `dist/`)
- `src/` — TypeScript sources
- `dist/` — production build output (generated by `npm run build`)

## Local development

1. Install dependencies:

```bash
npm install
```

2. Start the Vite dev server (recommended for editing TypeScript):

```bash
npm run dev
```

Open the URL printed by Vite (usually http://localhost:5173). The dev server serves `index.html` and handles TS HMR.

## Production build

To build a production-ready static site (assets go to `dist/`):

```bash
npm run build
```

`dist/` contains `index.html` and assets. The project is configured so built assets use relative paths (Vite `base: './'`) which makes the site suitable for GitHub Pages or serving from a subpath.

## Publish to GitHub Pages

There are two supported ways to publish:

- Local publish (manual):

  ```bash
  npm run deploy
  # uses the `gh-pages` npm package to push `dist/` to the gh-pages branch
  ```

- CI publish (recommended):

  The repo includes a GitHub Actions workflow at `.github/workflows/deploy.yml` which builds and deploys `dist/` to GitHub Pages when you push to `main`. The workflow uses the repository's `GITHUB_TOKEN` to push the built site — no additional secrets are required for basic publish.

Requirements and branch expectations

- The Actions workflow triggers on pushes to `main`. If your default branch is named differently, update `.github/workflows/deploy.yml`.
- The workflow uses the built-in `GITHUB_TOKEN` so it can push to `gh-pages`. If you require a different deployment strategy (deploy to a different branch or use a personal token), update the workflow accordingly.

## API key and configuration

The app reads a `config.json` at runtime if present (useful for local testing or static hosting). Example `config.example.json` is provided. Additionally, the settings modal (⚙️ button) lets you paste a custom ODPT API key which will be persisted to `localStorage` and used in preference to `config.json`.

How to supply an API key:

1. Copy `config.example.json` to `config.json` and set `ODPT_API_KEY` for a static, server-side config.

```json
{
  "ODPT_API_KEY": "YOUR_KEY_HERE",
  "DEFAULT_STATION_NAME": "武蔵小杉 (TY11)",
  "API_BASE_URL": "https://api-challenge.odpt.org/api/v4/"
}
```

2. Or: open the settings modal in the UI and paste a custom API key — this is persisted to `localStorage` under `t2board_api_key` and takes precedence over `config.json`.

If the app encounters an API error (for example an authentication error), it will display a banner and automatically open the settings modal so you can paste a new API key immediately.

## Scripts

- `npm run dev` — start Vite dev server
- `npm run build` — build for production (`dist/`)
- `npm run deploy` — build and publish `dist/` to `gh-pages` using `gh-pages` (local push)
- `npm run typecheck` — run `tsc --noEmit`
- `npm test` — run Vitest tests

## Formatting

This project uses Prettier. To format source files:

```bash
npm run format
```

## CI

The included Actions workflow runs on push to `main`, builds the site, and publishes the `dist/` directory to GitHub Pages using `peaceiris/actions-gh-pages`.

Notes & next steps

- Consider moving more settings (like API base URL) to `config.json` and adding validation.
- Add more unit tests for UI and caching behavior.
- Add ESLint and a GitHub Actions linting step if desired.
