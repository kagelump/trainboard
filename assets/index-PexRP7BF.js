(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();async function E(e,t=3,n=1e3){for(let i=0;i<t;i++)try{const o=await fetch(e);if(!o.ok)throw new Error(`HTTP ${o.status}`);return o}catch(o){if(i===t-1)throw o;await new Promise(s=>setTimeout(s,n*2**i))}throw new Error("Unreachable")}async function K(e,t,n){const i=new URLSearchParams({"acl:consumerKey":String(e)});i.append("odpt:railway",n),i.append("odpt:operator","odpt.Operator:Tokyu");const o=`${t}odpt:Station?${i.toString()}`;return await(await E(o)).json()}async function O(e,t,n){const i=(()=>{const d=new Date().getDay();return d>=1&&d<=5?"odpt.Calendar:Weekday":"odpt.Calendar:SaturdayHoliday"})(),o=new URLSearchParams({"acl:consumerKey":String(t),"odpt:railway":"odpt.Railway:Tokyu.Toyoko","odpt:station":e,"odpt:calendar":i}),s=`${n}odpt:StationTimetable?${o.toString()}`;return await(await E(s)).json()}async function N(e,t){const n=new URLSearchParams({"acl:consumerKey":String(e),"odpt:railway":"odpt.Railway:Tokyu.Toyoko"}),i=`${t}odpt:TrainInformation?${n.toString()}`;return await(await E(i)).json()}async function H(e,t,n){if(e.length===0)return[];const i=new URLSearchParams({"acl:consumerKey":String(t)});i.append("owl:sameAs",e.join(","));const o=`${n}odpt:Station?${i.toString()}`;return await(await E(o)).json()}function F(e){if(!e)return"N/A";if(typeof e=="string")return e;const t=e;return t.ja||t.en||"N/A"}function B(e){const[t,n]=e.split(":").map(i=>Number(i));return t*60+n}function g(e,t,n,i=10){return(e.find(a=>a["odpt:railDirection"]===t)?.["odpt:stationTimetableObject"]??[]).filter(a=>typeof a["odpt:departureTime"]=="string").filter(a=>B(a["odpt:departureTime"])>=n).slice(0,i)}function Y(...e){const t=new Set;for(const n of e)for(const i of n??[]){const o=i["odpt:destinationStation"];if(o)if(Array.isArray(o)){for(const s of o)if(s){if(typeof s=="string")t.add(s);else if(typeof s=="object"){const a=s["owl:sameAs"]||s["@id"]||s.id;a&&typeof a=="string"&&t.add(a)}}}else typeof o=="string"&&t.add(o)}return t}class J{constructor(t=500,n,i){if(this.maxEntries=t,this.ttlMs=n,this.persistKeyName=i,this.map=new Map,i&&typeof localStorage<"u")try{const o=localStorage.getItem(i);if(o){const s=JSON.parse(o);for(const a of Object.keys(s)){const d=s[a];(!d.expires||d.expires>Date.now())&&this.map.set(a,d)}}}catch{}}get(t){const n=this.map.get(t);if(n){if(n.expires&&n.expires<=Date.now()){this.map.delete(t);return}return this.map.delete(t),this.map.set(t,n),n.v}}set(t,n){const i=this.ttlMs?Date.now()+this.ttlMs:void 0;for(this.map.has(t)&&this.map.delete(t),this.map.set(t,{v:n,expires:i});this.map.size>this.maxEntries;){const o=this.map.keys().next().value;this.map.delete(o)}this.persistKeyName&&this.persist()}has(t){return typeof this.get(t)<"u"}persist(){if(this.persistKeyName)try{const t={};for(const[n,i]of this.map.entries())t[n]=i;localStorage.setItem(this.persistKeyName,JSON.stringify(t))}catch{}}keys(){return Array.from(this.map.keys())}enablePersistence(t){this.persistKeyName=t,this.persist()}}function C(e){const t=document.getElementById("station-header");t&&(t.textContent=e||"")}function z(){const e=document.getElementById("departures-inbound"),t=document.getElementById("departures-outbound"),n='<p class="text-center text-2xl pt-8">時刻表を取得中...</p>';e&&(e.innerHTML=n),t&&(t.innerHTML=n)}function X(e,t){const n=document.getElementById("direction-inbound-header"),i=document.getElementById("direction-outbound-header");n&&(n.textContent=e),i&&(i.textContent=t)}function h(e,t,n,i){const o=document.getElementById(`departures-${e}`);if(o){if(t.length===0){o.innerHTML='<p class="text-center text-2xl pt-8">本日の発車予定はありません。</p>';return}o.innerHTML=t.map(s=>{const a=s["odpt:departureTime"],d=s["odpt:trainType"]||"";let l="N/A";const c=s["odpt:destinationStation"];if(Array.isArray(c)&&c.length>0){const u=c[0];if(typeof u=="string")l=n.get(u)||u;else if(u&&typeof u=="object"&&(l=u["dc:title"]||u.title||"N/A",(!l||l==="N/A")&&u["owl:sameAs"])){const S=u["owl:sameAs"];typeof S=="string"&&(l=n.get(S)||S)}}else typeof c=="string"&&(l=n.get(c)||c);const p=i[d]||{name:"不明",class:"type-LOC"};return`
        <div class="train-row">
          <div class="time-col">${a}</div>
          <div class="flex justify-center items-center">
            <span class="train-type-badge ${p.class}">${p.name}</span>
          </div>
          <div class="destination-text">${l}行き</div>
        </div>`}).join("")}}function P(){const e=document.getElementById("time-header");if(!e)return;const t=new Date;e.textContent=`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}function G(e,t){const n=localStorage.getItem("t2board_station_uri"),i=e.find(s=>s.name===t)||e[0];let o=i;if(n){const s=e.find(a=>a.uri===n);s&&(o=s)}else e.length>0&&(o=i||e[0]);return o}function q(e,t,n){const i=document.getElementById("config-modal"),o=document.getElementById("station-select");if(!i||!o)return;function s(c){o.innerHTML=e.map(p=>`<option value="${p.uri}" ${p.uri===c?"selected":""}>${p.name}</option>`).join("")}s(t),document.getElementById("settings-button")?.addEventListener("click",()=>{s(t),R()}),document.getElementById("close-modal")?.addEventListener("click",()=>{L()}),document.getElementById("save-settings")?.addEventListener("click",()=>{const c=o.value;localStorage.setItem("t2board_station_uri",c),n(c),L()}),i.addEventListener("click",c=>{c.target===i&&L()})}function D(e,t){console.log("Open up API key modal setup");const n=document.getElementById("api-key-modal");console.log(n);const i=document.getElementById("api-key-input");if(console.log(i),!n||!i)return;i.value=e||"";const o=document.getElementById("save-api-key"),s=document.getElementById("close-api-key");o?.addEventListener("click",()=>{const a=i.value?i.value.trim():null;a?localStorage.setItem("t2board_api_key",a):localStorage.removeItem("t2board_api_key"),t(a),b()}),s?.addEventListener("click",()=>b()),n.addEventListener("click",a=>{a.target===n&&b()})}function R(){const e=document.getElementById("config-modal");e&&(e.classList.remove("hidden"),e.classList.add("flex","opacity-100"))}function L(){const e=document.getElementById("config-modal");e&&(e.classList.remove("flex","opacity-100"),e.classList.add("hidden"))}function x(){const e=document.getElementById("api-key-modal");e&&(e.classList.remove("hidden"),e.classList.add("flex","opacity-100"))}function b(){const e=document.getElementById("api-key-modal");e&&(e.classList.remove("flex","opacity-100"),e.classList.add("hidden"))}function A(e,t="info"){const n=document.getElementById("status-banner");n&&(n.classList.remove("hidden"),n.classList.remove("bg-red-100","bg-yellow-100","bg-blue-100","text-red-800"),t==="error"?n.classList.add("bg-red-100","text-red-800"):t==="warn"?n.classList.add("bg-yellow-100"):n.classList.add("bg-blue-100"),n.textContent=e)}function W(){const e=document.getElementById("status-banner");e&&(e.classList.add("hidden"),e.textContent="")}let r=null,m="https://api-challenge.odpt.org/api/v4/";const Q="odpt.Railway:Tokyu.Toyoko",k="odpt.RailDirection:Inbound",U="odpt.RailDirection:Outbound",V="渋谷・副都心線方面",Z="横浜・元町中華街方面",I={"odpt.TrainType:Tokyu.Local":{name:"各停",class:"type-LOC"},"odpt.TrainType:Tokyu.Express":{name:"急行",class:"type-EXP"},"odpt.TrainType:Tokyu.CommuterExpress":{name:"通勤急行",class:"type-CEXP"},"odpt.TrainType:Tokyu.LimitedExpress":{name:"特急",class:"type-LE"},"odpt.TrainType:Tokyu.CommuterLimitedExpress":{name:"通勤特急",class:"type-CLE"},"odpt.TrainType:Local":{name:"各停",class:"type-LOC"},"odpt.TrainType:Express":{name:"急行",class:"type-EXP"},"odpt.TrainType:LimitedExpress":{name:"特急",class:"type-LE"}};let y=[],j="武蔵小杉 (TY11)",T={stationUri:null},v,_;const f=new J(500);function tt(){const e=document.getElementById("settings-button");e&&e.addEventListener("click",()=>{try{const t=document.getElementById("api-key-input"),n=(()=>{try{return localStorage.getItem("t2board_api_key")}catch{return null}})();t&&(t.value=r||n||"")}catch{}R()})}tt();function et(e){return document.getElementById(e)}async function M(...e){if(!r)return;const t=Y(...e),n=Array.from(t).filter(i=>!f.has(i));if(n.length!==0)try{const i=await H(n,String(r),m);for(const o of i){const s=o["owl:sameAs"]||o["@id"]||o.id,a=F(o["dc:title"]||o["odpt:stationTitle"]||o.title);s&&typeof s=="string"&&f.set(s,a)}for(const o of n)f.has(o)||f.set(o,o)}catch(i){console.warn("Failed to fetch station names for destinations:",i)}}async function $(){if(!r){const a=document.getElementById("departures-inbound"),d=document.getElementById("departures-outbound");a&&(a.innerHTML='<p class="text-center text-red-500 text-2xl pt-8">エラー: config.json に ODPT_API_KEY を設定してください。</p>'),d&&(d.innerHTML='<p class="text-center text-red-500 text-2xl pt-8">エラー: config.json に ODPT_API_KEY を設定してください。</p>');return}typeof v<"u"&&clearInterval(v),typeof _<"u"&&clearInterval(_);const e=y.find(a=>a.uri===T.stationUri);if(!e){const a=et("station-header");a&&(a.textContent="エラー: 駅が選択されていません");return}C(e.name),z(),X(V,Z);let t=[];try{t=await O(e.uri,String(r),m)}catch(a){console.error("Failed to fetch timetable:",a),A("API エラーが発生しました。API キーを確認してください。","error"),x();return}const n=new Date,i=B(`${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}`),o=g(t,k,i),s=g(t,U,i);await M(o,s),h("inbound",o,f,I),h("outbound",s,f,I);try{await N(String(r),m),W()}catch(a){console.warn("Failed to fetch status:",a),A("運行情報取得でエラーが発生しました。API キーを確認してください。","warn")}v=window.setInterval(async()=>{let a=[];try{a=await O(e.uri,String(r),m)}catch(u){console.error("Periodic timetable fetch failed:",u),A("定期更新の取得中にエラーが発生しました。API キーを確認してください。","warn"),x();return}const d=new Date,l=B(`${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`),c=g(a,k,l),p=g(a,U,l);await M(c,p),h("inbound",c,f,I),h("outbound",p,f,I)},15e4),_=window.setInterval(()=>N(String(r),m),3e5),window.setInterval(P,1e3),P()}async function nt(){try{const e=await fetch("./config.json",{cache:"no-store"});if(!e.ok)return;const t=await e.json();t?.ODPT_API_KEY&&(r=t.ODPT_API_KEY),t?.DEFAULT_STATION_NAME&&(j=t.DEFAULT_STATION_NAME),t?.API_BASE_URL&&(m=t.API_BASE_URL)}catch(e){console.warn("Failed to load ./config.json:",e)}try{const e=localStorage.getItem("t2board_api_key");e&&(console.log("Overriding API key from localStorage"),r=e)}catch{}}async function w(){if(await nt(),console.log("ODPT_API_KEY:",r),!r){D(r,t=>{t&&(r=t),w()}),x();return}try{y=(await K(String(r),m,Q)).map(n=>{const i=n["dc:title"],o=n["odpt:stationCode"]||"";return{name:`${i} (${o})`,uri:n["owl:sameAs"]}}).sort((n,i)=>n.name.localeCompare(i.name,"ja"))}catch(t){console.error("Error fetching station list:",t),C("エラー: 駅リスト取得失敗")}const e=G(y,j);e&&(T={stationUri:e.uri,stationName:e.name}),D(r,t=>{t&&(r=t),w()}),q(y,T.stationUri,t=>{const n=y.find(i=>i.uri===t);T={stationUri:t,stationName:n?n.name:null},$()}),$()}window.initializeBoard=w;window.onload=w;
