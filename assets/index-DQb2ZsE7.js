(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();async function E(i,t=3,o=1e3){for(let e=0;e<t;e++)try{const n=await fetch(i);if(!n.ok)throw new Error(`HTTP ${n.status}`);return n}catch(n){if(e===t-1)throw n;await new Promise(s=>setTimeout(s,o*2**e))}throw new Error("Unreachable")}async function $(i,t,o){const e=new URLSearchParams({"acl:consumerKey":String(i)});e.append("odpt:railway",o),e.append("odpt:operator","odpt.Operator:Tokyu");const n=`${t}odpt:Station?${e.toString()}`;return await(await E(n)).json()}async function _(i,t,o){const e=(()=>{const c=new Date().getDay();return c>=1&&c<=5?"odpt.Calendar:Weekday":"odpt.Calendar:SaturdayHoliday"})(),n=new URLSearchParams({"acl:consumerKey":String(t),"odpt:railway":"odpt.Railway:Tokyu.Toyoko","odpt:station":i,"odpt:calendar":e}),s=`${o}odpt:StationTimetable?${n.toString()}`;return await(await E(s)).json()}async function b(i,t){const o=new URLSearchParams({"acl:consumerKey":String(i),"odpt:railway":"odpt.Railway:Tokyu.Toyoko"}),e=`${t}odpt:TrainInformation?${o.toString()}`;return await(await E(e)).json()}async function M(i,t,o){if(i.length===0)return[];const e=new URLSearchParams({"acl:consumerKey":String(t)});e.append("owl:sameAs",i.join(","));const n=`${o}odpt:Station?${e.toString()}`;return await(await E(n)).json()}function j(i){if(!i)return"N/A";if(typeof i=="string")return i;const t=i;return t.ja||t.en||"N/A"}function A(i){const[t,o]=i.split(":").map(e=>Number(e));return t*60+o}function g(i,t,o,e=10){return(i.find(r=>r["odpt:railDirection"]===t)?.["odpt:stationTimetableObject"]??[]).filter(r=>typeof r["odpt:departureTime"]=="string").filter(r=>A(r["odpt:departureTime"])>=o).slice(0,e)}function R(...i){const t=new Set;for(const o of i)for(const e of o??[]){const n=e["odpt:destinationStation"];if(n)if(Array.isArray(n)){for(const s of n)if(s){if(typeof s=="string")t.add(s);else if(typeof s=="object"){const r=s["owl:sameAs"]||s["@id"]||s.id;r&&typeof r=="string"&&t.add(r)}}}else typeof n=="string"&&t.add(n)}return t}class H{constructor(t=500,o,e){if(this.maxEntries=t,this.ttlMs=o,this.persistKeyName=e,this.map=new Map,e&&typeof localStorage<"u")try{const n=localStorage.getItem(e);if(n){const s=JSON.parse(n);for(const r of Object.keys(s)){const c=s[r];(!c.expires||c.expires>Date.now())&&this.map.set(r,c)}}}catch{}}get(t){const o=this.map.get(t);if(o){if(o.expires&&o.expires<=Date.now()){this.map.delete(t);return}return this.map.delete(t),this.map.set(t,o),o.v}}set(t,o){const e=this.ttlMs?Date.now()+this.ttlMs:void 0;for(this.map.has(t)&&this.map.delete(t),this.map.set(t,{v:o,expires:e});this.map.size>this.maxEntries;){const n=this.map.keys().next().value;this.map.delete(n)}this.persistKeyName&&this.persist()}has(t){return typeof this.get(t)<"u"}persist(){if(this.persistKeyName)try{const t={};for(const[o,e]of this.map.entries())t[o]=e;localStorage.setItem(this.persistKeyName,JSON.stringify(t))}catch{}}keys(){return Array.from(this.map.keys())}enablePersistence(t){this.persistKeyName=t,this.persist()}}function B(i){const t=document.getElementById("station-header");t&&(t.textContent=i||"")}function K(){const i=document.getElementById("departures-inbound"),t=document.getElementById("departures-outbound"),o='<p class="text-center text-2xl pt-8">時刻表を取得中...</p>';i&&(i.innerHTML=o),t&&(t.innerHTML=o)}function k(i,t){const o=document.getElementById("direction-inbound-header"),e=document.getElementById("direction-outbound-header");o&&(o.textContent=i),e&&(e.textContent=t)}function T(i,t,o,e){const n=document.getElementById(`departures-${i}`);if(n){if(t.length===0){n.innerHTML='<p class="text-center text-2xl pt-8">本日の発車予定はありません。</p>';return}n.innerHTML=t.map(s=>{const r=s["odpt:departureTime"],c=s["odpt:trainType"]||"";let a="N/A";const l=s["odpt:destinationStation"];if(Array.isArray(l)&&l.length>0){const u=l[0];if(typeof u=="string")a=o.get(u)||u;else if(u&&typeof u=="object"&&(a=u["dc:title"]||u.title||"N/A",(!a||a==="N/A")&&u["owl:sameAs"])){const I=u["owl:sameAs"];typeof I=="string"&&(a=o.get(I)||I)}}else typeof l=="string"&&(a=o.get(l)||l);const m=e[c]||{name:"不明",class:"type-LOC"};return`
        <div class="train-row">
          <div class="time-col">${r}</div>
          <div class="flex justify-center items-center">
            <span class="train-type-badge ${m.class}">${m.name}</span>
          </div>
          <div class="destination-text">${a}行き</div>
        </div>`}).join("")}}function v(){const i=document.getElementById("time-header");if(!i)return;const t=new Date;i.textContent=`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}function Y(i,t){const o=localStorage.getItem("t2board_station_uri"),e=i.find(s=>s.name===t)||i[0];let n=e;if(o){const s=i.find(r=>r.uri===o);s&&(n=s)}else i.length>0&&(n=e||i[0]);return n}function F(i,t,o){const e=document.getElementById("config-modal"),n=document.getElementById("station-select");if(!e||!n)return;n.innerHTML=i.map(a=>`<option value="${a.uri}" ${a.uri===t?"selected":""}>${a.name}</option>`).join(""),document.getElementById("settings-button")?.addEventListener("click",()=>{n.value=t||"",e.classList.remove("hidden"),e.classList.add("flex","opacity-100")}),document.getElementById("close-modal")?.addEventListener("click",()=>{e.classList.remove("flex","opacity-100"),e.classList.add("hidden")}),document.getElementById("save-settings")?.addEventListener("click",()=>{const a=n.value;localStorage.setItem("t2board_station_uri",a),o(a),e.classList.remove("flex","opacity-100"),e.classList.add("hidden")}),e.addEventListener("click",a=>{a.target===e&&(e.classList.remove("flex","opacity-100"),e.classList.add("hidden"))})}let d=null,f="https://api-challenge.odpt.org/api/v4/";const J="odpt.Railway:Tokyu.Toyoko",O="odpt.RailDirection:Inbound",N="odpt.RailDirection:Outbound",z="渋谷・副都心線方面",X="横浜・元町中華街方面",h={"odpt.TrainType:Tokyu.Local":{name:"各停",class:"type-LOC"},"odpt.TrainType:Tokyu.Express":{name:"急行",class:"type-EXP"},"odpt.TrainType:Tokyu.CommuterExpress":{name:"通勤急行",class:"type-CEXP"},"odpt.TrainType:Tokyu.LimitedExpress":{name:"特急",class:"type-LE"},"odpt.TrainType:Tokyu.CommuterLimitedExpress":{name:"通勤特急",class:"type-CLE"},"odpt.TrainType:Local":{name:"各停",class:"type-LOC"},"odpt.TrainType:Express":{name:"急行",class:"type-EXP"},"odpt.TrainType:LimitedExpress":{name:"特急",class:"type-LE"}};let y=[],U="武蔵小杉 (TY11)",w={stationUri:null},L,x;const p=new H(500);function S(i){return document.getElementById(i)}async function D(...i){if(!d)return;const t=R(...i),o=Array.from(t).filter(e=>!p.has(e));if(o.length!==0)try{const e=await M(o,String(d),f);for(const n of e){const s=n["owl:sameAs"]||n["@id"]||n.id,r=j(n["dc:title"]||n["odpt:stationTitle"]||n.title);s&&typeof s=="string"&&p.set(s,r)}for(const n of o)p.has(n)||p.set(n,n)}catch(e){console.warn("Failed to fetch station names for destinations:",e)}}async function P(){if(!d){const r=document.getElementById("departures-inbound"),c=document.getElementById("departures-outbound");r&&(r.innerHTML='<p class="text-center text-red-500 text-2xl pt-8">エラー: config.json に ODPT_API_KEY を設定してください。</p>'),c&&(c.innerHTML='<p class="text-center text-red-500 text-2xl pt-8">エラー: config.json に ODPT_API_KEY を設定してください。</p>');return}typeof L<"u"&&clearInterval(L),typeof x<"u"&&clearInterval(x);const i=y.find(r=>r.uri===w.stationUri);if(!i){const r=S("station-header");r&&(r.textContent="エラー: 駅が選択されていません");return}B(i.name),K(),k(z,X);const t=await _(i.uri,String(d),f),o=new Date,e=A(`${String(o.getHours()).padStart(2,"0")}:${String(o.getMinutes()).padStart(2,"0")}`),n=g(t,O,e),s=g(t,N,e);await D(n,s),T("inbound",n,p,h),T("outbound",s,p,h),await b(String(d),f),L=window.setInterval(async()=>{const r=await _(i.uri,String(d),f),c=new Date,a=A(`${String(c.getHours()).padStart(2,"0")}:${String(c.getMinutes()).padStart(2,"0")}`),l=g(r,O,a),m=g(r,N,a);await D(l,m),T("inbound",l,p,h),T("outbound",m,p,h)},15e4),x=window.setInterval(()=>b(String(d),f),3e5),window.setInterval(v,1e3),v()}async function G(){try{const i=await fetch("./config.json",{cache:"no-store"});if(!i.ok)return;const t=await i.json();t?.ODPT_API_KEY&&(d=t.ODPT_API_KEY),t?.DEFAULT_STATION_NAME&&(U=t.DEFAULT_STATION_NAME),t?.API_BASE_URL&&(f=t.API_BASE_URL)}catch(i){console.warn("Failed to load ./config.json:",i)}}async function C(){if(await G(),!d){const t=S("station-header");t&&(t.textContent="設定エラー: config.json に ODPT_API_KEY を設定してください");const o=S("departures-inbound"),e=S("departures-outbound");o&&(o.innerHTML='<p class="text-center text-red-500 text-2xl pt-8">エラー: config.json に ODPT_API_KEY を設定してください。</p>'),e&&(e.innerHTML='<p class="text-center text-red-500 text-2xl pt-8">エラー: config.json に ODPT_API_KEY を設定してください。</p>');return}try{y=(await $(String(d),f,J)).map(o=>{const e=o["dc:title"],n=o["odpt:stationCode"]||"";return{name:`${e} (${n})`,uri:o["owl:sameAs"]}}).sort((o,e)=>o.name.localeCompare(e.name,"ja"))}catch(t){console.error("Error fetching station list:",t),B("エラー: 駅リスト取得失敗")}const i=Y(y,U);i&&(w={stationUri:i.uri,stationName:i.name}),F(y,w.stationUri,t=>{const o=y.find(e=>e.uri===t);w={stationUri:t,stationName:o?o.name:null},P()}),P()}window.initializeBoard=C;window.onload=C;
