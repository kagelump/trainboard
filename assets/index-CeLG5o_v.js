(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();async function I(e,t=3,n=1e3){for(let i=0;i<t;i++)try{const o=await fetch(e);if(!o.ok)throw new Error(`HTTP ${o.status}`);return o}catch(o){if(i===t-1)throw o;await new Promise(s=>setTimeout(s,n*2**i))}throw new Error("Unreachable")}async function F(e,t,n){const i=new URLSearchParams({"acl:consumerKey":String(e)});i.append("odpt:railway",n),i.append("odpt:operator","odpt.Operator:Tokyu");const o=`${t}odpt:Station?${i.toString()}`;return await(await I(o)).json()}async function O(e,t,n){const i=(()=>{const a=new Date().getDay();return a>=1&&a<=5?"odpt.Calendar:Weekday":"odpt.Calendar:SaturdayHoliday"})(),o=new URLSearchParams({"acl:consumerKey":String(t),"odpt:railway":"odpt.Railway:Tokyu.Toyoko","odpt:station":e,"odpt:calendar":i}),s=`${n}odpt:StationTimetable?${o.toString()}`;return await(await I(s)).json()}async function P(e,t){const n=new URLSearchParams({"acl:consumerKey":String(e),"odpt:railway":"odpt.Railway:Tokyu.Toyoko"}),i=`${t}odpt:TrainInformation?${n.toString()}`;return await(await I(i)).json()}async function Y(e,t,n){if(e.length===0)return[];const i=new URLSearchParams({"acl:consumerKey":String(t)});i.append("owl:sameAs",e.join(","));const o=`${n}odpt:Station?${i.toString()}`;return await(await I(o)).json()}function J(e){if(!e)return"N/A";if(typeof e=="string")return e;const t=e;return t.ja||t.en||"N/A"}function B(e){const[t,n]=e.split(":").map(i=>Number(i));return t*60+n}function g(e,t,n,i=5){return(e.find(r=>r["odpt:railDirection"]===t)?.["odpt:stationTimetableObject"]??[]).filter(r=>typeof r["odpt:departureTime"]=="string").filter(r=>B(r["odpt:departureTime"])>=n).slice(0,i)}function z(...e){const t=new Set;for(const n of e)for(const i of n??[]){const o=i["odpt:destinationStation"];if(o)if(Array.isArray(o)){for(const s of o)if(s){if(typeof s=="string")t.add(s);else if(typeof s=="object"){const r=s["owl:sameAs"]||s["@id"]||s.id;r&&typeof r=="string"&&t.add(r)}}}else typeof o=="string"&&t.add(o)}return t}class X{constructor(t=500,n,i){if(this.maxEntries=t,this.ttlMs=n,this.persistKeyName=i,this.map=new Map,i&&typeof localStorage<"u")try{const o=localStorage.getItem(i);if(o){const s=JSON.parse(o);for(const r of Object.keys(s)){const a=s[r];(!a.expires||a.expires>Date.now())&&this.map.set(r,a)}}}catch{}}get(t){const n=this.map.get(t);if(n){if(n.expires&&n.expires<=Date.now()){this.map.delete(t);return}return this.map.delete(t),this.map.set(t,n),n.v}}set(t,n){const i=this.ttlMs?Date.now()+this.ttlMs:void 0;for(this.map.has(t)&&this.map.delete(t),this.map.set(t,{v:n,expires:i});this.map.size>this.maxEntries;){const o=this.map.keys().next().value;this.map.delete(o)}this.persistKeyName&&this.persist()}has(t){return typeof this.get(t)<"u"}persist(){if(this.persistKeyName)try{const t={};for(const[n,i]of this.map.entries())t[n]=i;localStorage.setItem(this.persistKeyName,JSON.stringify(t))}catch{}}keys(){return Array.from(this.map.keys())}enablePersistence(t){this.persistKeyName=t,this.persist()}}function H(e){const t=document.getElementById("station-header");t&&(t.textContent=e||"")}function q(){const e=document.getElementById("departures-inbound"),t=document.getElementById("departures-outbound"),n='<p class="text-center text-2xl pt-8">時刻表を取得中...</p>';e&&(e.innerHTML=n),t&&(t.innerHTML=n)}function G(e,t){const n=document.getElementById("direction-inbound-header"),i=document.getElementById("direction-outbound-header");n&&(n.textContent=e),i&&(i.textContent=t)}function h(e,t,n,i){const o=document.getElementById(`departures-${e}`);if(o){if(t.length===0){o.innerHTML='<p class="text-center text-2xl pt-8">本日の発車予定はありません。</p>';return}o.innerHTML=t.map(s=>{const r=s["odpt:departureTime"],a=s["odpt:trainType"]||"";let l="N/A";const c=s["odpt:destinationStation"];if(Array.isArray(c)&&c.length>0){const u=c[0];if(typeof u=="string")l=n.get(u)||u;else if(u&&typeof u=="object"&&(l=u["dc:title"]||u.title||"N/A",(!l||l==="N/A")&&u["owl:sameAs"])){const E=u["owl:sameAs"];typeof E=="string"&&(l=n.get(E)||E)}}else typeof c=="string"&&(l=n.get(c)||c);const p=i[a]||{name:"不明",class:"type-LOC"};return`
        <div class="train-row items-center justify-between">
          <div class="minutes-col w-24 text-center" data-departure="${r}">--</div>
          <div class="time-col w-24 text-center">${r}</div>
          <div class="flex justify-center items-center">
            <span class="train-type-badge ${p.class}">${p.name}</span>
          </div>
          <div class="destination-text">${l}</div>
        </div>`}).join("")}}let L;function W(e){const[t,n]=(e||"").split(":"),i=Number(t||0),o=Number(n||0);return i*3600+o*60}function D(){const e=Array.from(document.querySelectorAll("[data-departure]")),t=new Date,n=t.getHours()*3600+t.getMinutes()*60+t.getSeconds();for(const i of e){const o=i.getAttribute("data-departure")||"",r=W(o)-n;if(r<=0)i.textContent="出発";else if(r<=60)i.textContent="到着";else{const a=Math.ceil(r/60);i.textContent=`${a}分`}}}function U(e=15e3){D(),typeof L<"u"&&clearInterval(L),L=window.setInterval(D,e)}function k(){const e=document.getElementById("time-header");if(!e)return;const t=new Date;e.textContent=`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}function Q(e,t){const n=localStorage.getItem("t2board_station_uri"),i=e.find(s=>s.name===t)||e[0];let o=i;if(n){const s=e.find(r=>r.uri===n);s&&(o=s)}else e.length>0&&(o=i||e[0]);return o}function V(e,t,n){const i=document.getElementById("config-modal"),o=document.getElementById("station-select");if(!i||!o)return;function s(c){o.innerHTML=e.map(p=>`<option value="${p.uri}" ${p.uri===c?"selected":""}>${p.name}</option>`).join("")}s(t),document.getElementById("settings-button")?.addEventListener("click",()=>{s(t),Z()}),document.getElementById("close-modal")?.addEventListener("click",()=>{A()}),document.getElementById("save-settings")?.addEventListener("click",()=>{const c=o.value;localStorage.setItem("t2board_station_uri",c),n(c),A()}),i.addEventListener("click",c=>{c.target===i&&A()})}function M(e,t){console.log("Open up API key modal setup");const n=document.getElementById("api-key-modal");console.log(n);const i=document.getElementById("api-key-input");if(console.log(i),!n||!i)return;i.value=e||"";const o=document.getElementById("save-api-key"),s=document.getElementById("close-api-key");o?.addEventListener("click",()=>{const r=i.value?i.value.trim():null;r?localStorage.setItem("t2board_api_key",r):localStorage.removeItem("t2board_api_key"),t(r),b()}),s?.addEventListener("click",()=>b()),n.addEventListener("click",r=>{r.target===n&&b()})}function Z(){const e=document.getElementById("config-modal");e&&(e.classList.remove("hidden"),e.classList.add("flex","opacity-100"))}function A(){const e=document.getElementById("config-modal");e&&(e.classList.remove("flex","opacity-100"),e.classList.add("hidden"))}function N(){const e=document.getElementById("api-key-modal");e&&(e.classList.remove("hidden"),e.classList.add("flex","opacity-100"))}function b(){const e=document.getElementById("api-key-modal");e&&(e.classList.remove("flex","opacity-100"),e.classList.add("hidden"))}function v(e,t="info"){const n=document.getElementById("status-banner");n&&(n.classList.remove("hidden"),n.classList.remove("bg-red-100","bg-yellow-100","bg-blue-100","text-red-800"),t==="error"?n.classList.add("bg-red-100","text-red-800"):t==="warn"?n.classList.add("bg-yellow-100"):n.classList.add("bg-blue-100"),n.textContent=e)}function tt(){const e=document.getElementById("status-banner");e&&(e.classList.add("hidden"),e.textContent="")}let d=null,m="https://api-challenge.odpt.org/api/v4/";const et="odpt.Railway:Tokyu.Toyoko",C="odpt.RailDirection:Inbound",$="odpt.RailDirection:Outbound",nt="渋谷・副都心線方面",ot="横浜・元町中華街方面",T={"odpt.TrainType:Tokyu.Local":{name:"各停",class:"type-LOC"},"odpt.TrainType:Tokyu.Express":{name:"急行",class:"type-EXP"},"odpt.TrainType:Tokyu.CommuterExpress":{name:"通勤急行",class:"type-CEXP"},"odpt.TrainType:Tokyu.LimitedExpress":{name:"特急",class:"type-LE"},"odpt.TrainType:Tokyu.CommuterLimitedExpress":{name:"通勤特急",class:"type-CLE"},"odpt.TrainType:Tokyu.S-TRAIN":{name:"Sトレイン",class:"type-STR"},"odpt.TrainType:Tokyu.F-Liner":{name:"Fライナー",class:"type-FLN"},"odpt.TrainType:Local":{name:"各停",class:"type-LOC"},"odpt.TrainType:Express":{name:"急行",class:"type-EXP"},"odpt.TrainType:LimitedExpress":{name:"特急",class:"type-LE"}};let y=[],K="武蔵小杉 (TY11)",w={stationUri:null},_,x;const f=new X(500);function it(e){return document.getElementById(e)}async function R(...e){if(!d)return;const t=z(...e),n=Array.from(t).filter(i=>!f.has(i));if(n.length!==0)try{const i=await Y(n,String(d),m);for(const o of i){const s=o["owl:sameAs"]||o["@id"]||o.id,r=J(o["dc:title"]||o["odpt:stationTitle"]||o.title);s&&typeof s=="string"&&f.set(s,r)}for(const o of n)f.has(o)||f.set(o,o)}catch(i){console.warn("Failed to fetch station names for destinations:",i)}}async function j(){if(!d){const r=document.getElementById("departures-inbound"),a=document.getElementById("departures-outbound");r&&(r.innerHTML='<p class="text-center text-red-500 text-2xl pt-8">エラー: config.json に ODPT_API_KEY を設定してください。</p>'),a&&(a.innerHTML='<p class="text-center text-red-500 text-2xl pt-8">エラー: config.json に ODPT_API_KEY を設定してください。</p>');return}typeof _<"u"&&clearInterval(_),typeof x<"u"&&clearInterval(x);const e=y.find(r=>r.uri===w.stationUri);if(!e){const r=it("station-header");r&&(r.textContent="エラー: 駅が選択されていません");return}H(e.name),q(),G(nt,ot);let t=[];try{t=await O(e.uri,String(d),m)}catch(r){console.error("Failed to fetch timetable:",r),v("API エラーが発生しました。API キーを確認してください。","error"),N();return}const n=new Date,i=B(`${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}`),o=g(t,C,i),s=g(t,$,i);await R(o,s),h("inbound",o,f,T),h("outbound",s,f,T),U();try{await P(String(d),m),tt()}catch(r){console.warn("Failed to fetch status:",r),v("運行情報取得でエラーが発生しました。API キーを確認してください。","warn")}_=window.setInterval(async()=>{let r=[];try{r=await O(e.uri,String(d),m)}catch(u){console.error("Periodic timetable fetch failed:",u),v("定期更新の取得中にエラーが発生しました。API キーを確認してください。","warn"),N();return}const a=new Date,l=B(`${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`),c=g(r,C,l),p=g(r,$,l);await R(c,p),h("inbound",c,f,T),h("outbound",p,f,T),U()},15e4),x=window.setInterval(()=>P(String(d),m),3e5),window.setInterval(k,1e3),k()}async function st(){try{const e=await fetch("./config.json",{cache:"no-store"});if(!e.ok)return;const t=await e.json();t?.ODPT_API_KEY&&(d=t.ODPT_API_KEY),t?.DEFAULT_STATION_NAME&&(K=t.DEFAULT_STATION_NAME),t?.API_BASE_URL&&(m=t.API_BASE_URL)}catch(e){console.warn("Failed to load ./config.json:",e)}}async function rt(){await st();try{console.log("Loading from localstorage ",Date.now());const e=localStorage.getItem("t2board_api_key");e&&(console.log("Overriding API key from localStorage"),d=e)}catch{}}async function S(){try{await rt()}catch(t){console.warn("Error loading local config:",t)}if(console.log("ODPT_API_KEY:",d,Date.now()),!d){M(d,t=>{t&&(d=t),S()}),N();return}try{y=(await F(String(d),m,et)).map(n=>{const i=n["dc:title"],o=n["odpt:stationCode"]||"";return{name:`${i} (${o})`,uri:n["owl:sameAs"]}}).sort((n,i)=>n.name.localeCompare(i.name,"ja"))}catch(t){console.error("Error fetching station list:",t),H("エラー: 駅リスト取得失敗")}const e=Q(y,K);e&&(w={stationUri:e.uri,stationName:e.name}),M(d,t=>{t&&(d=t),S()}),V(y,w.stationUri,t=>{const n=y.find(i=>i.uri===t);w={stationUri:t,stationName:n?n.name:null},j()}),j()}window.initializeBoard=S;window.onload=S;
